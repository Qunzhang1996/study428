## 问题

虚函数你了解多少？工作机制是什么？

## 虚函数知识点

● 虚函数是指在**基类内部**声明的成员函数前添加**关键字 virtual 指明的函数**

● 虚函数存在的意义是为了**实现多态**，**让派生类能够重写(override)**其基类的成员函数

● 派生类重写基类的虚函数时，可以添加 virtual 关键字，但不是必须这么做

● 虚函数**是动态绑定的，在运行时才确定**，而非虚函数的调用在编译时确定

● 虚函数**必须是非静态成员函数**，因为静态成员函数需要在编译时确定

● **构造函数不能是**虚函数，因为虚函数是动态绑定的，而构造函数创建时需要确定对象类型

● **析构函数一般是**虚函数

● 虚函数一旦声明，就一直是虚函数，派生类也无法改变这一事实



## 虚函数的工作机制

**主要思路**

虚函数表 + 虚表指针

**具体实现** 

● 编译器在含有虚函数的类中创建一个虚函数表，称为vtable，这个vtable用来存放虚函数的地址。另外还隐式地设置了一个虚表指针，称为vptr，这个vptr指向了该类对象的虚函数表。

● 派生类在继承基类的同时，也会继承基类的虚函数表。

● 当派生类重写（override）了基类的虚函数时，则会将重写后的虚函数的地址 **替换掉** 由基类继承而来的虚函数表中对应虚函数的地址。

● 若派生类没有重写，则由基类继承而来的虚函数的地址将直接保存在派生类的虚函数表中。

**注意**

每个类都只有一个虚函数表，**该类的所有对象共享这个虚函数表**，而不是每个实例化对象都分别有一个虚函数表。



**C++类的多态性是通过虚函数来实现的。如果基类通过引用或指针调用的是虚函数时，我们并不知道执行该函数的对象是什么类型的，只有在运行时才能确定调用的是基类的虚函数还是派生类中的虚函数，这就是运行时多态。**

